---
import BaseLayout from '../layouts/BaseLayout.astro';
import Section from '../components/Section.astro';
import { getCollection } from 'astro:content';
import Button from '../components/Button.astro';

const allEvents = await getCollection('events');
const sortedEvents = allEvents.sort((a, b) => 
  new Date(a.data.date).getTime() - new Date(b.data.date).getTime()
);

const eventTypes = ['atelier', 'cdmc', 'cours-individuels', 'autre'] as const;
---

<BaseLayout 
  title="Agenda - Ghost-Note"
  description="Consultez l'agenda des prochains √©v√©nements Ghost-Note : ateliers, CDMC, cours individuels et autres rendez-vous."
>
  <!-- Hero -->
  <Section class="text-center">
    <h1 class="text-4xl md:text-5xl font-bold text-fg mb-6">Agenda</h1>
    <p class="text-xl text-muted max-w-2xl mx-auto">
      Tous les prochains √©v√©nements et rendez-vous
    </p>
  </Section>

  <!-- Filtres -->
  <Section>
    <div class="max-w-4xl mx-auto">
      <div class="flex flex-wrap gap-2 mb-8 justify-center" id="event-filters">
        <button 
          class="px-4 py-2 rounded-lg border border-fg/20 text-sm font-medium transition-colors hover:border-accent hover:text-accent active-filter"
          data-filter="all"
        >
          Tous
        </button>
        {eventTypes.map((type) => (
          <button 
            class="px-4 py-2 rounded-lg border border-fg/20 text-sm font-medium transition-colors hover:border-accent hover:text-accent"
            data-filter={type}
          >
            {type === 'atelier' ? 'Ateliers' : 
             type === 'cdmc' ? 'CDMC' : 
             type === 'cours-individuels' ? 'Cours individuels' : 
             'Autre'}
          </button>
        ))}
      </div>

      <!-- Liste des √©v√©nements -->
      {sortedEvents.length > 0 ? (
        <div class="space-y-6" id="events-list">
          {sortedEvents.map((event) => {
            const eventDate = new Date(event.data.date);
            const formattedDate = eventDate.toLocaleDateString('fr-FR', {
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              year: 'numeric',
            });
            const formattedTime = eventDate.toLocaleTimeString('fr-FR', {
              hour: '2-digit',
              minute: '2-digit',
            });
            
            return (
              <div 
                class="p-6 rounded-lg border border-fg/10 hover:border-accent/50 transition-colors event-item"
                data-event-type={event.data.type}
              >
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                  <div class="flex-1">
                    <div class="text-sm text-muted mb-2">
                      {formattedDate} √† {formattedTime}
                    </div>
                    <h3 class="text-2xl font-semibold text-fg mb-3">{event.data.title}</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                      <span class="inline-block px-2 py-1 bg-fg/5 rounded text-xs font-medium">
                        {event.data.type === 'atelier' ? 'Atelier' : 
                         event.data.type === 'cdmc' ? 'CDMC' : 
                         event.data.type === 'cours-individuels' ? 'Cours individuel' : 
                         'Autre'}
                      </span>
                      {event.data.level && (
                        <span class="inline-block px-2 py-1 bg-fg/5 rounded text-xs font-medium">
                          {event.data.level}
                        </span>
                      )}
                    </div>
                    <div class="space-y-2 text-sm text-muted">
                      {event.data.city && <div>üìç {event.data.city}</div>}
                      {event.data.venue && <div>üè¢ {event.data.venue}</div>}
                      {event.data.duration && <div>‚è±Ô∏è {event.data.duration}</div>}
                      {event.data.price && <div>üí∞ {event.data.price}</div>}
                    </div>
                    {event.body && (
                      <div class="mt-4 prose prose-sm text-muted">
                        <p>{event.body}</p>
                      </div>
                    )}
                  </div>
                  {event.data.cta_url && (
                    <div class="flex-shrink-0">
                      <a 
                        href={event.data.cta_url}
                        class="inline-block px-6 py-3 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors font-medium"
                      >
                        {event.data.cta_label || 'En savoir plus'}
                      </a>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-12 text-muted">
          <p class="mb-4">Aucun √©v√©nement annonc√© pour le moment.</p>
          <Button href="/contact" variant="outline">Contactez-nous pour √™tre inform√©¬∑e</Button>
        </div>
      )}
    </div>
  </Section>
</BaseLayout>

<script>
  const filters = document.querySelectorAll<HTMLElement>('[data-filter]');
  const eventItems = document.querySelectorAll<HTMLElement>('.event-item');
  
  filters.forEach((filter) => {
    filter.addEventListener('click', () => {
      const filterValue = filter.getAttribute('data-filter');
      
      // Update active filter
      filters.forEach((f) => f.classList.remove('active-filter', 'bg-accent', 'text-white', 'border-accent'));
      filter.classList.add('active-filter', 'bg-accent', 'text-white', 'border-accent');
      
      // Filter events
      eventItems.forEach((item) => {
        if (filterValue === 'all' || item.getAttribute('data-event-type') === filterValue) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  .active-filter {
    background-color: var(--accent);
    color: white;
    border-color: var(--accent);
  }
</style>

